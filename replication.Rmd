---
title: "Mining Android Sandboxes Using Dynamic and Static Analysis: a Replication Study" 
author: "da Costa et al."
date: "March, 2021"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd(".")
require(sqldf)
require(reshape2)
require(xtable)
require(kableExtra)
require(ggplot2)
require(VennDiagram)
require(ggvenn)
```

## Replication Package

This is the replication package for the paper *Mining Android Sandboxes Using Dynamic and Static Analysis: a
Replication Study*. 

### Authors

   * Francisco Handrick da Costa
   * Ismael Medeiros
   * Thales Menezes
   * João Victor da Silva
   * Ingrid Lorraine da Silva
   * Rodrigo Bonifácio
   * Krishna Narasimhanb
  
### Abstract

The use of sandboxes is an effective technique for malware analysis. However, although the use of dynamic
analysis for mining Android sandboxes has been investigated before, little is known about the potential
benefits of combining static and dynamic analysis for mining Android sandboxes. Accordingly, in this paper
we present the results of two studies that investigate whether or not static analysis might complement and
increase the performance of dynamic analysis tools for mining Android sandboxes. In the first study we
conduct a non-exact replication of the Bao et al. study, a previous work that compares the performance
of test case generation tools for mining Android sandboxes. Differently from the original work, here we
isolate the effect of the static analysis tool (DroidFax) they used to instrument the Android apps in their
experiments. This decision was motivated by the fact that DroidFax could have influenced the efficacy of
the dynamic analyses positively—through the execution of specific static analysis algorithms. In our second
study, we carried out a new experiment to investigate the efficacy of tainted analysis algorithms for mining
Android sandboxes. To this end, we executed the FlowDroid tool to mine the source-sink flows from the
benign/malign pairs of Android apps used in the Bao et al. study. Our study brings several findings. For
instance, the first study reveals that DroidFax alone (static analysis) can detect 43.75% of the malwares in
the dataset of the Bao et al. work, leading to an overestimation of the performance of the dynamic analysis
tools. The results of the second study show that (static) taint analysis is also practical for mining Android
sandboxes, with a performance similar to that reached by dynamic analysis tools.

### Data Analysis

#### Load the Datasets

```{r}
ds <- read.csv("results.csv", head=T, sep=",")
```


#### Summary of the Results (**Table 1**)

````{r}
staticAnalysis <- sqldf("select tool, count(distinct app) totalWith
                        from ds 
                        where malware = 1 and static = 1 and tool != 'flowdroid'
                        group by tool")

withoutStaticAnalysis <-  sqldf("select tool, count(distinct app) totalWithout
                                  from ds 
                                  where malware = 1 and static = 0
                                  group by tool")

res <- merge(staticAnalysis, withoutStaticAnalysis, all.x=T)

res[is.na(res)] <- 0
res["Improvement"] = (res$totalWith  - res$totalWithout) * 100 / res$totalWith 

res <- res[order(-res$totalWith),]

colnames(res) <- c("Tool", "Using Static Analysis",	"Without Using Static Analysis", "Improvement")
res %>% kable("html") 
```


#### Compare the performance of the different tools (with static analysis)

```{r, venn-plot-s1}
sets <- sqldf("select tool, app, count(*) total 
                  from ds 
                  where malware = 1 and static = 1
                  group by tool, app")

monkey = sets[sets$tool=="monkey", c("app")]
humanoid = sets[sets$tool=="humanoid", c("app")]
droidmate = sets[sets$tool=="droidmate", c("app")]
droidbot = sets[sets$tool=="droidbot", c("app")]
joker = sets[sets$tool=="joke", c("app")]

x <- list(
  Monkey = monkey,
  Humanoid = humanoid, 
  DroidMate = droidmate,
  DroidBot = droidbot
)

ggvenn(
 x,
 fill_color = c("#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF","#CD534CAA"),
   stroke_size = 0.5, set_name_size = 4, text_size=2
)
```


#### Compare the performance of FlowDroid and DroidFax (Joker tool)

```{r, venn-plot-s2}
sets <- sqldf("select tool, app 
                  from ds 
                  where malware = 1 
                    and (tool='flowdroid' or tool = 'joke')")

notDetected <- sqldf("select distinct app from ds where 
                      app not in (select app from sets)")


flowdroid = sets[sets$tool=="flowdroid", c("app")]
droidfax = sets[sets$tool=="joke", c("app")]
notDetected = sets[, c("app")]

x <- list(
  FlowDroid = flowdroid,
  DroidFax = droidfax
)

ggvenn(
 x,
 fill_color = c("#0073C2FF", "#EFC000FF"),
   stroke_size = 0.5, set_name_size = 4, text_size=2.5
)

```

### Malware dataset

```{r echo=FALSE}
apps <- sqldf("select app, tool, sum(malware) total
               from ds 
               group by app, tool")

apps["detected"] <- ifelse(apps$total > 0, "x", "")
apps <- apps[,c("app", "tool", "detected")]
apps <- dcast(apps, app~tool)
apps["diff"] <- paste0("[diff/", apps$app, ".txt]", "(", "./diff/dif", gsub("-", "_", toupper(apps$app)), ".txt", ")")


info <- read.csv("allInfoApps.csv", head=T, sep=",")

info <- info[, c("id", "pkg_name", "hash")]
colnames(info) <- c("app", "name")
apps <- merge(apps, info)
```



```{r echo = FALSE}
apps %>%
  kable("html") %>%
  kable_styling(font_size = 12)  %>% 
  kable_styling("striped") %>% 
  scroll_box(width = "100%")

```
